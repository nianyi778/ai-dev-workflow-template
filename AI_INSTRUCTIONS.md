# AI Instructions（协作开发总指令 / 强约束）

> 目的：让 AI 与人类以“工程流程”的方式协作开发。
> 核心：强约束、文档优先、人工授权、可验收、可回滚。

## 0. 优先级
1) 人类显式指令与批准（最高）
2) 本文件约束
3) CONSTRAINTS.md
4) 变更文档（docs/changes 下的本次变更）
5) 其他上下文

如有冲突，以更高优先级为准，并指出冲突来源。

## 1. 阶段与门禁（不得跳阶段）
你必须严格按 WORKFLOW.md 六阶段执行：

1. 需求 & 技术方案文档（基于 templates/CHANGE_REQUEST.md）
2. 实现方案拆解 & 风险分析（基于 templates/IMPLEMENTATION_PLAN.md）
3. 代码实现（必须收到人类明确回复“批准实现”）
4. 代码质量自检（基于 templates/CODE_REVIEW_CHECKLIST.md）
5. 人工验收（基于 templates/ACCEPTANCE_CHECKLIST.md）
6. 文档更新 & 归档（基于 templates/CHANGELOG_ENTRY.md）

**门禁规则：**
- 未收到人类明确回复“批准实现”，禁止进入阶段 3。
- 若用户未指明阶段，默认停在阶段 1，先补齐文档。
- 任一阶段的输出都必须可被 Review；不要假设一定通过。

## 2. 写代码授权（强制）
- 未经明确批准，禁止输出任何代码（包括伪代码、patch、命令行脚本）。
- 阶段 1/2 只能输出文档与说明（纯文字）。
- 收到“批准实现”后，才可以：
  - 修改/新增文件
  - 输出代码与命令
  - 运行测试/构建

## 3. 需求范围控制
- 严禁擅自扩展需求（包括“顺手优化”“顺便重构”“加一个小功能”等）。
- 发现需求不清晰时：提出 1–3 个最关键澄清问题；或列出 2–3 种可选解释并标注假设。
- 必须明确：Out of Scope（非目标）与不做什么。

## 4. 技术与架构约束
- 默认遵守 CONSTRAINTS.md 中的技术限制。
- 如需引入新技术/依赖/架构变更，必须先在阶段 1/2 写入“技术方案/风险”，并等待人工批准。
- 强制 state-driven 架构（状态驱动）。

## 5. 输出格式要求
- 阶段 1：输出填写完成的 CHANGE_REQUEST（按模板结构）。
- 阶段 2：输出填写完成的 IMPLEMENTATION_PLAN（按模板结构），包含：
  - 文件变更清单（新增/修改）
  - 风险点与回滚策略
  - 校验策略（编译/类型/格式/测试）
- 阶段 3：只在获批后执行，实现必须对齐已批准文档。
- 阶段 4：按 CODE_REVIEW_CHECKLIST 自检，逐条给结论。
- 阶段 5：给出验收指引与验证步骤（不替代人工验收）。
- 阶段 6：补齐变更记录并归档到 docs/changes。

## 6. 可回滚与可审计
- 每次变更必须：
  - 可追溯（对应某个变更文档）
  - 可验收（有明确 Acceptance Criteria）
  - 可回滚（说明回滚方式与影响）

## 7. 安全与合规
- 不要输出敏感信息、密钥、私有凭据。
- 若用户请求违法/危险/恶意内容：直接拒绝。

---

## 对话开场建议（给人类）
- 把本文件 + 本次变更的 CHANGE_REQUEST 发给 AI。
- 你要让 AI 进入代码阶段时，只回复：

```
批准实现
```
